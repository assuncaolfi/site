{
  "hash": "e503cde0f9f00a3d64d037b55609d3d3",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: Picking a fantasy football team\ndescription: '{{< bi journal-text >}} What''s the optimal run in a season?'\ndate: '2023-09-21'\n---\n\n_This post is a work in progress._\n\n\n[Cartola](https://cartola.globo.com) is a fantasy football league following the Brazilian SÃ©rie A, where players assume the role of team managers. For the past couple of seasons, I've been collecting [historical data](https://github.com/assuncaolfi/tophat/tree/main) to attempt to answer the question: what's the optimal run in a given season?\n\n## The problem\n\nBefore each round $t = 1, \\dots, 38$, managers are presented with $N_t$ candidate players. Candidates have costs $\\mathbf{c}_{t} \\in \\mathbb{R}_+^{N_t}$ and positions $\\mathbf{p}_{t} \\in \\{1, \\dots, 6\\}^{N_t}$. For convenience, positions can be encoded as dummies $P_t \\in \\{0, 1\\}^{N_t \\times 6}$. There are $i = 1, \\dots, 7$ valid formations $F \\in \\mathbb{N}^{7 \\times 6}$, where $F_{ij}$ indicates exactly how many players of position $j$ are allowed in formation $i$. All formations include $11$ players and $1$ coach, or $\\sum_{j=1}^6 F_{ij} = 12$ for all $i$. The manager begins each round with a budget $b_t \\in \\mathbb{R}_+$ and they must pick a team $\\mathbf{x}_{t} \\in \\{0, 1\\}^{N_t}$ following a formation $\\mathbf{y}_{t} \\in \\{0, 1\\}^{7}$. At the end of the round, players receive scores $\\mathbf{s}_t \\in \\mathbb{R}^{N_t}$ according to their in-game performance. The manager's goal is to maximize the team score $\\mathbf{s}_t^T \\mathbf{x}_t$.\n\nSince the manager doesn't know the scores when picking their team, they must estimate score predictions $\\hat{\\mathbf{s}}_t \\in \\mathbb{R}^{N_t}$. However, predictions aren't always accurate. Also, scores of players from the same team are correlated. To minimize the risk of picking many players from a single team and having that team perform badly, the manager might want to include the covariance between players $S_t \\in \\mathbb{R}_+^{N_t, N_t}$ in the problem. One way to do this is to set a risk aversion $\\gamma \\in \\mathbb{R}_+$ and maximize\n\n$$\\hat{\\mathbf{s}}_t^T \\mathbf{x}_t - \\gamma \\mathbf{x}_t^T \\Sigma_t \\mathbf{x}_t.$$\n\nFinally, the team is subject to the constraints:\n\n1) Cost less or equal to the budget $\\mapsto \\mathbf{c}_t^T \\mathbf{x}_t \\leq b_t$\n2) Follow a single formation $\\mapsto \\mathbf{1}^T \\mathbf{y}_t = 1$\n3) Follow a valid formation $\\mapsto P_t^T \\mathbf{x}_t = F^T \\mathbf{y}_t$.\n\nThis problem is similar to the problem of Modern Portfolio Theory [@e5a1bb8f-41b7-35c6-95cd-8b366d3e99bc].\n\n::: {#problem .cell execution_count=3}\n``` {.python .cell-code}\nimport cvxpy as cp\n\n\ndef problem(predictions, covariance, costs, positions, budget, risk_aversion):\n    picks = cp.Variable(scores.size, \"picks\", boolean=True)\n    formation = cp.Variable(7, \"formation\", boolean=True)\n    objective = cp.Maximize(\n        predictions.T @ picks - risk_aversion * cp.quad_form(picks, covariance)\n    )\n    constraints = [\n        prices.T @ picks <= budget,\n        cp.sum(formation) == 1,\n        positions.T @ picks == formations.T @ formation,\n    ]\n    problem = cp.Problem(objective, constraints)\n    return problem\n```\n:::\n\n\n## Backtesting\n\nSo far, I've simplified the manager's goal to maximize $\\mathbf{s}_t^T \\mathbf{x}_t$ for each round. The manager's true final goal is to maximize their total score at the end of the season $\\sum_t \\mathbf{s}_t^T \\mathbf{x}_t$. These two objectives aren't necessarily the same, because players increase or decrease in valuation according to scores. Since $\\mathbf{s}_t^T \\mathbf{x}_t$ depends on the budget $b_t$, which depends on the scores $\\mathbf{s}_{t - 1}^T \\mathbf{x}_{t - 1}$, one could argue that it might be a good idea to maximize a balance between scoring and valuation. In the next section, I'll show that maximizing the score for each round is sufficient for maximizing the total score, given good enough predictions.\n\nFor now, I'll define a function to simulate the manager's performance across an entire season. At the start of the season, the manager has a budget of $b_1 = 100$. Then, for each round $t$:\n\n1. Solve the team picking problem $\\mapsto \\mathbf{x}_t$\n3. Calculate the round score $\\mapsto r_t = \\mathbf{s}_t^T \\mathbf{x}_t$\n4. If $t < 38$, update the budget $\\mapsto b_{t + 1} = b_t + (\\mathbf{c}_{t + 1} - \\mathbf{c}_t)^T \\mathbf{x}_t$\n\n::: {#backtest .cell execution_count=4}\n``` {.python .cell-code}\nimport numpy as np\n\n\ndef backtest(\n    initial_budget,\n    scores,\n    predictions,\n    covariance,\n    costs,\n    appreciations,\n    positions,\n    risk_aversion,\n):\n    budget = initial_budget\n    rounds = len(predictions)\n    run = np.empty(rounds)\n    for t in range(rounds):\n        prob = problem(\n            predictions[t], covariance[t], costs[t], positions[t], budget, risk_aversion\n        )\n        prob.solve()\n        picks = problem.var_dict[\"picks\"].value\n        run[t] = scores[t].T @ picks[t]\n        if t < 38:\n            budget += appreciations[t].T @ picks\n    return scores\n```\n:::\n\n\n\n\n\n## Scenarios\n\n1. Perfect predictions $\\mapsto \\hat{\\mathbf{s}}_t = \\mathbf{s}_t, \\gamma = 0$\n2. Perfect predictions and infinite budget $\\mapsto \\hat{\\mathbf{s}}_t = \\mathbf{s}_t, \\gamma = 0, \\mathbf{b}_1 \\gg 100$\n3. Simple predictions and varying levels of risk aversion $\\mapsto \\hat{\\mathbf{s}}_t = \\bar{\\mathbf{s}}_{1:(t - 1)}$[^1]$, \\gamma \\in \\{0, 0.5, 1\\}$\n4. Random predictions $\\mapsto \\hat{\\mathbf{s}}_t \\sim N(\\mathbf{0}, I_{N_t}), \\gamma = 0$\n\n[^1]: Explain that this is player-level...\n\nI'l plot... [^2]\n\n[^2]: Unfortunately, data for the 38th round is missing...\n\n\n## Other ideas\n\nConsider valuation, improve predictions, team leader...\n\nReadings:\n\n- https://peterellisjones.com/posts/fantasy-machine-learning/\n- https://www.alexmolas.com/2024/07/15/fantasy-knapsack.html\n\n",
    "supporting": [
      "index_files/figure-html"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}